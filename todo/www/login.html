<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CT UAV - Project Management</title>
    <!-- Tải Tailwind CSS từ CDN để có các class tiện ích -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Tải Font Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Tùy chỉnh hiệu ứng nền và icon drone */
        @keyframes floating {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(-250px, -250px);
            }
        }

        @keyframes flyAcross {
            0% {
                left: -50px;
                top: 20%;
                transform: rotate(-15deg);
            }

            25% {
                left: 25%;
                top: 15%;
                transform: rotate(5deg);
            }

            50% {
                left: 50%;
                top: 25%;
                transform: rotate(-10deg);
            }

            75% {
                left: 75%;
                top: 10%;
                transform: rotate(8deg);
            }

            100% {
                left: calc(100% + 50px);
                top: 20%;
                transform: rotate(-5deg);
            }
        }

        .animated-bg::before {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            background-image:
                radial-gradient(3px 3px at 20px 30px, rgba(59, 130, 246, 0.4), transparent),
                radial-gradient(3px 3px at 40px 70px, rgba(239, 68, 68, 0.4), transparent),
                radial-gradient(2px 2px at 90px 40px, rgba(16, 185, 129, 0.3), transparent),
                radial-gradient(2px 2px at 130px 80px, rgba(168, 85, 247, 0.3), transparent),
                radial-gradient(1px 1px at 160px 30px, rgba(59, 130, 246, 0.5), transparent),
                radial-gradient(1px 1px at 200px 100px, rgba(239, 68, 68, 0.5), transparent);
            background-repeat: repeat;
            background-size: 250px 250px;
            animation: floating 25s linear infinite;
            opacity: 0.7;
        }

        .drone-animation::after {
            /* Biểu tượng UAV mới, có hình dáng máy bay không người lái cánh cố định */
            content: '';
            background-image: url('https://cdn4.iconfinder.com/data/icons/blue-common-symbols-vol-1/2327/drone_2_uav_aircraft_dawdler_app_mobile-512.png');
            background-size: contain;
            background-repeat: no-repeat;
            position: absolute;
            width: 20px;
            height: 20px;
            animation: flyAcross 15s linear infinite;
            z-index: 1;
        }

        .btn-login:hover::before {
            left: 100%;
        }

        @keyframes borderGlow {

            0%,
            100% {
                transform: rotate(0deg);
            }

            50% {
                transform: rotate(180deg);
            }
        }

        .logo::before {
            content: '';
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            background: linear-gradient(45deg, #3b82f6, #ef4444, #10b981, #3b82f6);
            border-radius: 23px;
            z-index: -1;
            animation: borderGlow 4s linear infinite;
        }
    </style>
</head>

<body
    class="bg-slate-900 flex items-center justify-center max-h-screen relative overflow-hidden animated-bg drone-animation">
    <div
        class="bg-white bg-opacity-95 py-4 backdrop-blur-lg border border-white border-opacity-30 rounded-3xl shadow-2xl p-10 max-w-lg w-full m-5 relative z-10 transition-all duration-500 ease-in-out transform hover:scale-[1.01]">
        <div class="text-center mb-10">
            <div class="flex flex-col items-center justify-center mb-6">
                <div
                    class="logo w-24 h-24 bg-white bg-opacity-95 rounded-2xl flex items-center justify-center mb-4 relative overflow-hidden shadow-lg border border-white border-opacity-20 transition-transform duration-300 hover:scale-105">
                    <img src="https://ctuav.vn/wp-content/uploads/2024/08/Logo-moi-ctuav-300x269.png" alt="CT UAV Logo"
                        class="w-20 h-auto object-contain drop-shadow-md">
                </div>
                <h1
                    class="text-3xl font-bold bg-clip-text bg-gradient-to-r from-blue-500 to-red-500 text-transparent mb-1">
                    CT UAV</h1>
                <p class="text-sm text-slate-500 font-normal">Better fly - Better life</p>
                <p class="text-base font-semibold text-slate-700 mt-2">Project Management System</p>
            </div>
        </div>

        <form id="login-form" onsubmit="handleLogin(event)">
            <div class="mb-6 relative">
                <label for="username" class="block text-slate-700 text-sm font-medium mb-2">Tên đăng nhập hoặc
                    Email</label>
                <input type="text" id="username" name="username"
                    class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 focus:border-blue-500 focus:shadow-md focus:shadow-blue-200 focus:outline-none"
                    required autocomplete="username" placeholder="Nhập tên đăng nhập...">
            </div>

            <div class="mb-6 relative">
                <label for="password" class="block text-slate-700 text-sm font-medium mb-2">Mật khẩu</label>
                <input type="password" id="password" name="password"
                    class="w-full px-5 py-4 border-2 border-gray-200 rounded-xl text-base transition-all duration-300 focus:border-blue-500 focus:shadow-md focus:shadow-blue-200 focus:outline-none"
                    required autocomplete="current-password" placeholder="Nhập mật khẩu...">
            </div>

            <div class="flex items-center mb-6 text-sm">
                <input type="checkbox" id="remember" name="remember"
                    class="w-4 h-4 text-blue-600 rounded border-gray-300 focus:ring-blue-500 mr-2">
                <label for="remember" class="text-gray-600">Ghi nhớ đăng nhập</label>
            </div>

            <button type="submit"
                class="btn-login w-full py-4 bg-gradient-to-r from-blue-500 to-red-500 text-white rounded-xl text-base font-semibold cursor-pointer transition-all duration-300 relative overflow-hidden shadow-md hover:shadow-xl hover:translate-y-[-2px] active:translate-y-[-1px] disabled:opacity-60 disabled:cursor-not-allowed">
                Đăng nhập hệ thống
            </button>

            <div class="text-center mt-4">
                <div class="loading hidden text-blue-500 text-sm">
                    <div
                        class="inline-block animate-spin rounded-full h-5 w-5 border-2 border-blue-200 border-t-blue-500 mr-2">
                    </div>
                    Đang xác thực thông tin...
                </div>
                <div
                    class="error-message hidden mt-4 p-3 bg-red-100 border-l-4 border-red-500 text-red-700 rounded-md text-sm">
                </div>
                <div
                    class="success-message hidden mt-4 p-3 bg-green-100 border-l-4 border-green-500 text-green-700 rounded-md text-sm">
                </div>
            </div>
        </form>

        <!-- <div class="text-center mt-8 pt-6 border-t border-gray-200">
            <a href="#" onclick="showForgotPassword()"
                class="text-blue-500 hover:text-red-500 text-sm font-medium mx-4 transition-all duration-200 relative group">
                Quên mật khẩu?
            </a>
            <a href="/app/login"
                class="text-blue-500 hover:text-red-500 text-sm font-medium mx-4 transition-all duration-200 relative group">
                Đăng nhập Frappe
            </a>
        </div> -->
    </div>

    <script>
        // Use an object to manage message states for cleaner code
        const messages = {
            error: document.querySelector('.error-message'),
            success: document.querySelector('.success-message'),
            loading: document.querySelector('.loading')
        };
        const loginBtn = document.querySelector('.btn-login');

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('username').focus();
            checkLoginStatus();
        });

        function showMessage(type, message) {
            messages.error.classList.add('hidden');
            messages.success.classList.add('hidden');
            if (type === 'error') {
                messages.error.textContent = message;
                messages.error.classList.remove('hidden');
            } else if (type === 'success') {
                messages.success.textContent = message;
                messages.success.classList.remove('hidden');
            }
        }

        function handleLogin(event) {
            event.preventDefault();

            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const remember = document.getElementById('remember').checked;

            if (!username || !password) {
                showMessage('error', 'Vui lòng nhập đầy đủ thông tin đăng nhập');
                return;
            }

            loginBtn.disabled = true;
            messages.loading.classList.remove('hidden');
            messages.error.classList.add('hidden');

            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/method/login', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

            xhr.onload = () => {
                loginBtn.disabled = false;
                messages.loading.classList.add('hidden');

                if (xhr.status === 200) {
                    showMessage('success', 'Đăng nhập thành công!');
                    setTimeout(() => {
                        window.location.href = (username === 'Administrator') ? '/app' : '/todo';
                    }, 1000);
                } else {
                    let errorMessage = 'Đăng nhập thất bại. Vui lòng kiểm tra lại thông tin.';
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.message) {
                            errorMessage = response.message;
                        } else if (response._server_messages) {
                            const messages = JSON.parse(response._server_messages);
                            if (messages.length > 0) {
                                const message = JSON.parse(messages[0]);
                                errorMessage = message.message || errorMessage;
                            }
                        }
                    } catch (e) {
                        if (xhr.status === 401) {
                            errorMessage = 'Tên đăng nhập hoặc mật khẩu không đúng';
                        }
                    }
                    showMessage('error', errorMessage);
                }
            };

            xhr.onerror = () => {
                loginBtn.disabled = false;
                messages.loading.classList.add('hidden');
                showMessage('error', 'Lỗi kết nối máy chủ. Vui lòng thử lại.');
            };

            const data = `usr=${encodeURIComponent(username)}&pwd=${encodeURIComponent(password)}&remember_me=${remember ? '1' : '0'}`;
            xhr.send(data);
        }

        function showForgotPassword() {
            // Using a custom modal-like div instead of alert()
            const modal = document.createElement('div');
            modal.style = `
                position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                padding: 20px 30px; background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                text-align: center; z-index: 1000; max-width: 350px;
                animation: fadeIn 0.3s ease-out;
            `;
            modal.innerHTML = `
                <h3 class="font-bold text-lg mb-2">Thông báo</h3>
                <p class="text-sm mb-4">Tính năng quên mật khẩu sẽ được phát triển trong phiên bản tiếp theo.</p>
                <button onclick="this.parentNode.remove()" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-colors">Đóng</button>
            `;
            document.body.appendChild(modal);
        }

        function checkLoginStatus() {
            const xhr = new XMLHttpRequest();
            xhr.open('GET', '/api/method/frappe.auth.get_logged_user', true);
            xhr.onload = () => {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        if (response.message && response.message !== 'Guest') {
                            window.location.href = (response.message === 'Administrator') ? '/app' : '/todo';
                        }
                    } catch (e) {
                        // Not logged in, continue
                    }
                }
            };
            xhr.send();
        }

        document.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !loginBtn.disabled) {
                handleLogin(e);
            }
        });
    </script>
</body>

</html>